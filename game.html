<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>g2 - HTML å¯¼å‡º</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: 'HarmonyOS Sans', 'Segoe UI', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1e1b4b 0%, #030617 70%);
      color: #f8fafc;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .gal-shell {
      position: relative;
      width: min(1100px, 100%);
      padding: 2rem;
      border-radius: 1.5rem;
      background: rgba(2, 6, 23, 0.9);
      box-shadow: 0 25px 60px rgba(2, 6, 23, 0.65);
      box-sizing: border-box;
    }
    .gal-stage-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
      z-index: 40;
    }
    .gal-stage-control {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.85);
      color: #f8fafc;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
      box-shadow: 0 8px 20px rgba(2, 6, 23, 0.6);
    }
    .gal-stage-control:hover {
      border-color: rgba(129, 140, 248, 0.9);
      background: rgba(99, 102, 241, 0.45);
      transform: translateY(-1px);
    }
    .gal-overlay-toggle[aria-pressed='false'] {
      border-color: rgba(248, 113, 113, 0.8);
      background: rgba(239, 68, 68, 0.25);
    }
    .gal-settings-panel {
      position: absolute;
      top: 4.5rem;
      right: 1rem;
      width: 260px;
      padding: 1rem;
      border-radius: 1rem;
      border: 1px solid rgba(99, 102, 241, 0.4);
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 20px 50px rgba(2, 6, 23, 0.7);
      display: none;
      flex-direction: column;
      gap: 1rem;
      z-index: 60;
    }
    .gal-settings-panel.is-open {
      display: flex;
    }
    .gal-settings-panel h3 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.05em;
    }
    .gal-settings-panel button {
      border-radius: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.7);
      color: #f8fafc;
      padding: 0.5rem;
      cursor: pointer;
    }
    .gal-settings-panel input[type='range'] {
      width: 100%;
      accent-color: #818cf8;
    }
    .gal-settings-section {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding-bottom: 0.6rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .gal-settings-section:last-of-type {
      border-bottom: none;
      padding-bottom: 0;
    }
    .gal-menu-button {
      font-size: 0.95rem;
      letter-spacing: 0.06em;
    }
    .gal-menu-button[aria-pressed='true'] {
      border-color: rgba(129, 140, 248, 0.8);
      background: rgba(99, 102, 241, 0.35);
    }
    .gal-stage {
      position: relative;
      margin: 0 auto;
      width: min(960px, 100%);
      aspect-ratio: 16 / 9;
      border-radius: 1.4rem;
      border: 1px solid rgba(99, 102, 241, 0.35);
      box-shadow: 0 25px 60px rgba(2, 6, 23, 0.65);
      overflow: hidden;
      background: #0f172a;
      background-image: var(--background-image, none);
      background-size: cover;
      background-position: center;
    }
    .gal-view {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
      display: flex;
    }
    .gal-view.is-active {
      opacity: 1;
      pointer-events: auto;
    }
    .gal-view--scene {
      isolation: isolate;
    }
    .gal-view--graph {
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: linear-gradient(180deg, rgba(2, 6, 23, 0.65), rgba(2, 6, 23, 0.92));
    }
    .gal-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      background: linear-gradient(180deg, rgba(2, 6, 23, 0.2), rgba(2, 6, 23, 0.9));
      padding: 1.5rem;
      box-sizing: border-box;
      z-index: 5;
      transition: opacity 200ms ease;
    }
    .gal-overlay.is-hidden {
      opacity: 0;
      pointer-events: none;
    }
    .gal-title {
      margin: 0 0 0.6rem 0;
      font-size: 1.5rem;
    }
    .gal-text {
      margin: 0;
      font-size: 1rem;
      line-height: 1.7;
      color: rgba(248, 250, 252, 0.92);
      white-space: pre-wrap;
    }
    .gal-choices {
      margin-top: 1.2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .gal-choice {
      flex: 1;
      min-width: 140px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.65);
      color: #f8fafc;
      padding: 0.65rem 1rem;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .gal-choice:hover:not(:disabled) {
      background: rgba(99, 102, 241, 0.3);
      border-color: rgba(129, 140, 248, 0.8);
    }
    .gal-choice:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .gal-characters {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2;
    }
    .gal-character {
      position: absolute;
      transform: translate(-50%, -100%) scale(var(--scale, 1));
      left: calc(var(--x, 50) * 1%);
      top: calc(var(--y, 70) * 1%);
      transition: transform 180ms ease, left 180ms ease, top 180ms ease;
      max-width: 40%;
    }
    .gal-character img {
      width: 100%;
      display: block;
    }
    .gal-graph-hint {
      position: absolute;
      top: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      color: rgba(248, 250, 252, 0.7);
      pointer-events: none;
    }
    .gal-graph {
      width: 100%;
      height: 100%;
    }
    .gal-graph-lines line {
      stroke: rgba(148, 163, 184, 0.35);
      stroke-width: 2;
    }
    .gal-graph-node circle {
      fill: rgba(15, 23, 42, 0.75);
      stroke: rgba(129, 140, 248, 0.6);
      stroke-width: 2;
      transition: transform 160ms ease, stroke 160ms ease;
    }
    .gal-graph-node:not(.is-unlocked) circle {
      stroke-dasharray: 5 6;
      opacity: 0.65;
    }
    .gal-graph-node.is-unlocked circle {
      stroke-dasharray: none;
    }
    .gal-graph-node.is-current circle {
      stroke: #f472b6;
      stroke-width: 3;
    }
    .gal-graph-node text {
      fill: rgba(248, 250, 252, 0.85);
      font-size: 0.8rem;
      text-anchor: middle;
      letter-spacing: 0.06em;
    }
    .gal-graph-node.is-unlocked circle:hover {
      transform: scale(1.05);
    }
    .gal-audio {
      position: absolute;
      width: 0;
      height: 0;
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="gal-shell" id="gal-root">
    <div class="gal-stage" id="gal-stage">
      <div class="gal-stage-controls">
        <button
          class="gal-stage-control gal-overlay-toggle"
          id="gal-overlay-toggle"
          type="button"
          aria-pressed="true"
          aria-label="åˆ‡æ¢å‰§æƒ…æ–‡æœ¬æ˜¾ç¤º"
          title="éšè—å‰§æƒ…æ–‡æœ¬"
        >
          ğŸ‘
        </button>
        <button
          class="gal-stage-control gal-settings-toggle"
          id="gal-settings-toggle"
          type="button"
          aria-label="æ‰“å¼€è®¾ç½®"
          title="æ‰“å¼€è®¾ç½®"
        >
          âš™
        </button>
      </div>
      <div class="gal-settings-panel" id="gal-settings-panel">
        <section class="gal-settings-section">
          <h3>å£°éŸ³è®¾ç½®</h3>
          <button id="gal-mute-toggle" type="button">é™éŸ³</button>
          <label style="display:flex; flex-direction:column; gap:0.35rem; font-size:0.85rem;">
            éŸ³é‡
            <input type="range" id="gal-volume" min="0" max="1" step="0.05" value="1" />
          </label>
        </section>
        <section class="gal-settings-section">
          <h3>å‰§æƒ…ç»“æ„å›¾</h3>
          <button id="gal-view-toggle" class="gal-menu-button" type="button" aria-pressed="false">å‰§æƒ…ç»“æ„å›¾</button>
        </section>
      </div>
      <div class="gal-view gal-view--scene is-active" id="gal-scene-view" aria-hidden="false">
        <div class="gal-characters" id="gal-characters"></div>
        <div class="gal-overlay" id="gal-overlay">
          <h2 class="gal-title" id="gal-title">åœºæ™¯æ ‡é¢˜</h2>
          <p class="gal-text" id="gal-text">å‰§æƒ…æ–‡æœ¬</p>
          <div class="gal-choices" id="gal-choices"></div>
        </div>
      </div>
      <div class="gal-view gal-view--graph" id="gal-graph-view" aria-hidden="true">
        <div class="gal-graph-hint" id="gal-graph-hint">æ¸¸ç©èŠ‚ç‚¹åå³å¯è§£é”ç»“æ„å›¾</div>
        <svg class="gal-graph" id="gal-graph" role="presentation" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
    </div>
    <audio id="gal-audio" class="gal-audio" preload="auto" loop playsinline></audio>
  </div>
  <script>
    window.GAL_EXPORT_DATA = {"projectName":"g2","generatedAt":"2025-12-06T11:34:39.898Z","startSceneId":"startLobby","scenes":[{"id":"startLobby","title":"ä¼‘æ¯å®¤çš„å–§é—¹å¼€ç«¯","text":"åˆ€åŒºå›¢æ’­å¼€å¹•ï¼Œä¸‰é…’åœ¨æ´»åŠ¨ä¼‘æ¯å®¤å¯»æ‰¾çªç ´å£ã€‚ç»çºªäººæé†’ä»–ï¼šä»Šæ™šçš„æŠ‰æ‹©å¯èƒ½å†³å®šæœªæ¥ã€‚","background":"../resources/background/2-2.png","audio":"../resources/audio/mofa_[cut_245sec].mp3","characters":[],"choices":[{"id":"choice-friends","label":"å»å’Œé˜¿è•Šã€è€è‘±æ‰“æ‹›å‘¼","targetId":"oldFriends"},{"id":"choice-observe","label":"èº²åœ¨è§’è½è§‚å¯Ÿï¼Œæ³¨æ„åˆ°æ¶‚æ¶‚","targetId":"observeCorner"},{"id":"choice-pea","label":"ä¸»åŠ¨æ‰¾ç´§å¼ çš„è±Œè±†æ­è¯","targetId":"meetPea"}]},{"id":"oldFriends","title":"è€å‹çš„å†ä¼š","text":"é˜¿è•Šé‚€è¯·ä½ ç»§ç»­ç»„é˜Ÿï¼Œè€è‘±æ‰“è¶£å´è¯é‡Œæœ‰è¯ã€‚ä½ æ„è¯†åˆ°è€å‹ä»¬ä¹Ÿæœ‰è‡ªå·±çš„å¿ƒäº‹ã€‚","background":"../resources/background/oldFriends.png","audio":"","characters":[],"choices":[{"id":"choice-arui","label":"å’Œé˜¿è•Šæ·±å…¥èŠèŠ","targetId":"aruiBranch"},{"id":"choice-laocong","label":"å’Œè€è‘±å•ç‹¬å–ä¸€æ¯","targetId":"laocongBranch"},{"id":"choice-return-pea","label":"å›åˆ°ä¸»èˆå°å¯»æ‰¾è±Œè±†","targetId":"meetPea"}]},{"id":"observeCorner","title":"è§’è½é‡Œçš„æ¸©æŸ”æ°”æ³¡","text":"ä½ çœ‹åˆ°æŠ±ç€çƒ­æ°´ï¼Œå¥¹è…¼è…†åœ°ç‚¹å¤´ã€‚ä¹Ÿè®¸å¥¹èƒ½ç†è§£ä½ çš„ç„¦è™‘ã€‚","background":"../resources/background/observeCorner-1.png","audio":"","characters":[],"choices":[{"id":"choice-talk-tutu","label":"è¿‡å»æ­è¯ï¼Œå¼€å¯æ¸©æŸ”æ”¯çº¿","targetId":"tutuBranch"},{"id":"choice-back-pea","label":"é¼“èµ·å‹‡æ°”å»æ‰¾è±Œè±†","targetId":"meetPea"}]},{"id":"meetPea","title":"ä¸è±Œè±†çš„åˆé‡","text":"ä½ å®‰æŠšç´§å¼ çš„è±Œè±†ï¼Œå†³å®šä¸€èµ·é¢å¯¹ç›´æ’­ä»»åŠ¡ã€‚å‘½è¿ä¼¼ä¹åœ¨æ­¤åˆ»æ‚„æ‚„è¿ç»“ã€‚","background":"../resources/background/meetPea.png","audio":"","characters":[],"choices":[{"id":"choice-safe","label":"æŒ‰éƒ¨å°±ç­ï¼Œå®‰å…¨å®ŒæˆèŠ‚ç›®","targetId":"safePerformance"},{"id":"choice-addDrama","label":"ä¸»åŠ¨åŠ æˆï¼Œåˆ¶é€ CPæ•ˆæœ","targetId":"cpBoom"}]},{"id":"safePerformance","title":"æ³¢æ¾œä¸æƒŠçš„æ¼”å‡º","text":"ç›´æ’­é¡ºåˆ©å´å¹³æ·¡ï¼Œç²‰ä¸æ²¡æœ‰è¢«ç‚¹ç‡ƒã€‚ä½ æ„Ÿåˆ°é”™å¤±æœºä¼šçš„é—æ†¾ã€‚","background":"../resources/background/safePerformance-2.png","audio":"","characters":[],"choices":[{"id":"choice-regret","label":"åæ€å¹¶å†æ¬¡å¯»æ‰¾æœºä¼š","targetId":"spotlightPressure"}]},{"id":"cpBoom","title":"å·¥ä¸šç³–ç²¾ç¬é—´çˆ†ç‚¸","text":"å€Ÿä½äº²å¯†è§¦å‘å¼¹å¹•ç‹‚æ¬¢ï¼Œâ€œé…’è±Œâ€CPä¸€å¤œæˆåã€‚è±Œè±†åˆå®³ç¾åˆå…´å¥‹ã€‚","background":"../resources/background/cpBoom.png","audio":"","characters":[],"choices":[{"id":"choice-into-press","label":"è¿æ¥äººæ°”æµ·å•¸","targetId":"spotlightPressure"}]},{"id":"spotlightPressure","title":"äººæ°”ä¸å‹åŠ›çš„äº¤é”‹","text":"ç›´æ’­é—´è¢«CPç²‰å é¢†ï¼Œè€ç²‰æŠ±æ€¨ã€‚è±Œè±†ä¹Ÿå¼€å§‹å®³æ€•è¢«æµé‡æ¨åŠ¨ç€èµ°ã€‚","background":"../resources/background/spotlightPressure-1.png","audio":"","characters":[],"choices":[{"id":"choice-keepCp","label":"ç»§ç»­è¥ä¸šï¼Œå†²å‡»æµé‡é¡¶å³°","targetId":"trafficSlave"},{"id":"choice-cooldown","label":"ç›´æ’­ä¸­å…¬å¼€é™æ¸©ï¼Œå›å½’æ¸¸æˆ","targetId":"trueEndingRoute"},{"id":"choice-seekAdvice","label":"æ‰¾ä¿¡ä»»çš„æœ‹å‹å€¾è¯‰","targetId":"supportChoice"}]},{"id":"supportChoice","title":"æœ‹å‹é—´çš„çœŸå¿ƒå¯¹è¯","text":"ä½ éœ€è¦ä¸€ä¸ªå‡ºå£ã€‚é˜¿è•Šç»™å‡ºç†æ€§æ–¹æ¡ˆï¼Œæ¶‚æ¶‚é€’æ¥æ¸©æš–å®‰æ…°ã€‚","background":"../resources/background/supportChoice-2.png","audio":"","characters":[],"choices":[{"id":"choice-talk-arui","label":"è¯·é˜¿è•Šå¸®å¿™åˆ†æèŠ‚å¥","targetId":"aruiBranch"},{"id":"choice-talk-tutu2","label":"å‘æ¶‚æ¶‚è¯‰è¯´å‹åŠ›","targetId":"tutuBranch"},{"id":"choice-back-main","label":"å¸¦ç€ç­”æ¡ˆå›åˆ°æŠ‰æ‹©ç‚¹","targetId":"trueEndingRoute"}]},{"id":"aruiBranch","title":"æˆ˜å‹çš„é»˜å¥‘","text":"é˜¿è•ŠåŠå¼€ç©ç¬‘åœ°åƒé†‹ï¼Œå´è¿˜æ˜¯å¸®ä½ æ¢³ç†ç­–ç•¥ï¼Œä¹Ÿæš—ç¤ºå¥¹å¹¶ä¸åªæ˜¯åŒä¼´ã€‚","background":"../resources/background/aruiBranch.png","audio":"","characters":[],"choices":[{"id":"choice-returnMain1","label":"å›åˆ°ä¸»çº¿æŠ‰æ‹©","targetId":"spotlightPressure"}]},{"id":"laocongBranch","title":"å…„å¼Ÿçš„è¿·èŒ«","text":"è€è‘±ä»¥åƒšæœºèº«ä»½æ”¯æŒä½ ï¼ŒåŒæ—¶å¦ç™½è‡ªå·±æ­£åœ¨ä¸ºè½¬å‹è€Œè‹¦æ¼ã€‚","background":"../resources/background/laocongBranch.png","audio":"","characters":[],"choices":[{"id":"choice-encourage","label":"é¼“åŠ±è€è‘±ï¼Œä¹Ÿæ£€è§†è‡ªå·±çš„åˆå¿ƒ","targetId":"spotlightPressure"}]},{"id":"tutuBranch","title":"æ¸©æŸ”çš„é¿é£æ¸¯","text":"æ¶‚æ¶‚é€’ç»™ä½ çƒ­èŒ¶ï¼š\"åšè‡ªå·±å°±å¥½\"ã€‚ä½ æš‚æ—¶ä»å–§åš£ä¸­æŠ½èº«ã€‚","background":"../resources/background/tutuBranch.png","audio":"","characters":[],"choices":[{"id":"choice-peace","label":"å¸¦ç€æ…°è—‰å›åˆ°èˆå°","targetId":"spotlightPressure"}]},{"id":"trueEndingRoute","title":"çœŸç»“å±€çš„æŠ‰æ‹©","text":"ä½ é€‰æ‹©åœ¨ç›´æ’­ä¸­é™æ¸©ï¼Œå¼•å¯¼ç²‰ä¸å…³æ³¨å†…å®¹æœ¬èº«ã€‚è±Œè±†æ¾äº†ä¸€å£æ°”ã€‚","background":"../resources/background/trueEndingRoute.png","audio":"","characters":[],"choices":[{"id":"choice-finalA","label":"å†·æ·¡å›åº”å¼¹å¹•","targetId":"neutralEnding"},{"id":"choice-finalB","label":"å‹å¥½å¼•å¯¼ç²‰ä¸æ”¯æŒè±Œè±†","targetId":"supportEnding"},{"id":"choice-finalC","label":"å·å·ä¸‹æ’­","targetId":"trueEnding"}]},{"id":"trafficSlave","title":"æµé‡å¥´éš¶ç»“å±€","text":"ä½ æ²‰è¿·äºCPçº¢åˆ©ï¼Œè±Œè±†è¢«è¿«è¥ä¸šï¼Œæœ€ç»ˆä¸¤äººå…³ç³»ç ´è£‚ã€äººæ°”åå™¬ã€‚","background":"../resources/background/trafficSlave.png","audio":"","characters":[],"choices":[]},{"id":"neutralEnding","title":"æ“¦è‚©è€Œè¿‡çš„ç»ˆå±€","text":"ä½ å†·æ·¡åº”å¯¹å¼¹å¹•ï¼Œç²‰ä¸å¤±æœ›ç¦»å¼€ï¼Œè±Œè±†ä¹Ÿé€æ¸ä¸æ‚¨ä¿æŒè·ç¦»ï¼Œæ•…äº‹æ— ç–¾è€Œç»ˆã€‚","background":"../resources/background/neutralEnding.png","audio":"","characters":[],"choices":[]},{"id":"supportEnding","title":"äº’ç›¸æˆå°±çš„ä¼™ä¼´","text":"ä½ é¼“åŠ±ç²‰ä¸æ”¯æŒè±Œè±†ï¼Œå½¼æ­¤ç‹¬ç«‹å´äº’ç›¸æ‰¶æŒï¼Œç•™ä¸‹ä¸€æ®µæˆç†Ÿçš„æ­æ¡£å…³ç³»ã€‚","background":"../resources/background/supportEnding.png","audio":"","characters":[],"choices":[]},{"id":"trueEnding","title":"æ˜Ÿå…‰ä¸‹çš„çœŸå¿ƒ","text":"ç›´æ’­ç»“æŸåï¼Œä½ å’Œè±Œè±†ç‰µæ‰‹èµ°åœ¨å¤œè·¯ä¸Šï¼š\"è°¢è°¢ä½ åœ¨æœ€æ··ä¹±çš„æ—¶å€™ä¿æŠ¤æˆ‘ã€‚\"å·¥ä¸šCPå‡åä¸ºçœŸå®çˆ±æƒ…ã€‚","background":"../resources/background/trueEnding.jpg","audio":"","characters":[],"choices":[]}]};
  </script>
  <script>
(() => {
  const data = window.GAL_EXPORT_DATA;
  if (!data || !data.startSceneId) {
    document.getElementById('gal-root').innerHTML = '<p>æœªæ‰¾åˆ°å¯æ’­æ”¾çš„åœºæ™¯ã€‚</p>';
    return;
  }

  const sceneMap = new Map(data.scenes.map((scene) => [scene.id, scene]));
  if (!sceneMap.size) {
    document.getElementById('gal-root').innerHTML = '<p>æœªæ‰¾åˆ°å¯æ’­æ”¾çš„åœºæ™¯ã€‚</p>';
    return;
  }

  const stage = document.getElementById('gal-stage');
  const sceneView = document.getElementById('gal-scene-view');
  const graphView = document.getElementById('gal-graph-view');
  const graphSvg = document.getElementById('gal-graph');
  const graphHint = document.getElementById('gal-graph-hint');
  const textTitle = document.getElementById('gal-title');
  const textBody = document.getElementById('gal-text');
  const choicesContainer = document.getElementById('gal-choices');
  const charactersLayer = document.getElementById('gal-characters');
  const audioPlayer = document.getElementById('gal-audio');
  const settingsToggle = document.getElementById('gal-settings-toggle');
  const settingsPanel = document.getElementById('gal-settings-panel');
  const muteButton = document.getElementById('gal-mute-toggle');
  const volumeSlider = document.getElementById('gal-volume');
  const viewToggleButton = document.getElementById('gal-view-toggle');
  const overlayContainer = document.getElementById('gal-overlay');
  const overlayToggleButton = document.getElementById('gal-overlay-toggle');

  let currentSceneId = data.startSceneId;
  let userMuted = false;
  let userVolume = 1;
  let isOverlayVisible = true;
  let activeAudioSrc = null;
  let fallbackAudioSrc = null;
  let pendingAudioUnlockHandler = null;
  const unlockedScenes = new Set();
  const viewState = { current: 'scene' };

  if (audioPlayer) {
    audioPlayer.loop = true;
    audioPlayer.preload = 'auto';
  }

  const applyAudioSettings = () => {
    audioPlayer.muted = userMuted;
    audioPlayer.volume = userVolume;
    if (muteButton) {
      muteButton.textContent = userMuted ? 'å–æ¶ˆé™éŸ³' : 'é™éŸ³';
    }
    if (volumeSlider) {
      volumeSlider.value = userVolume;
    }
  };

  const applyOverlayVisibility = () => {
    if (overlayContainer) {
      overlayContainer.classList.toggle('is-hidden', !isOverlayVisible);
    }
    if (overlayToggleButton) {
      overlayToggleButton.setAttribute('aria-pressed', isOverlayVisible ? 'true' : 'false');
      overlayToggleButton.textContent = isOverlayVisible ? 'ğŸ‘' : 'ğŸ™ˆ';
      overlayToggleButton.title = isOverlayVisible ? 'éšè—å‰§æƒ…æ–‡æœ¬' : 'æ˜¾ç¤ºå‰§æƒ…æ–‡æœ¬';
    }
  };

  const cleanupPendingAudioUnlock = () => {
    if (!pendingAudioUnlockHandler) return;
    document.removeEventListener('pointerdown', pendingAudioUnlockHandler);
    pendingAudioUnlockHandler = null;
  };

  const requestAudioPlayback = () => {
    if (!audioPlayer) return;
    const playResult = audioPlayer.play();
    if (playResult && typeof playResult.catch === 'function') {
      playResult.catch(() => {
        if (pendingAudioUnlockHandler) return;
        pendingAudioUnlockHandler = () => {
          const retryResult = audioPlayer.play();
          if (retryResult && typeof retryResult.then === 'function') {
            retryResult.then(
              () => cleanupPendingAudioUnlock(),
              () => cleanupPendingAudioUnlock(),
            );
          } else {
            cleanupPendingAudioUnlock();
          }
        };
        document.addEventListener('pointerdown', pendingAudioUnlockHandler, { once: true });
      });
    }
  };

  const handleSceneAudio = (scene) => {
    if (!audioPlayer) return;
    const nextAudioSrc = scene && scene.audio ? scene.audio : null;

    if (nextAudioSrc) {
      fallbackAudioSrc = nextAudioSrc;
      if (activeAudioSrc !== nextAudioSrc) {
        activeAudioSrc = nextAudioSrc;
        audioPlayer.src = nextAudioSrc;
        if (typeof audioPlayer.load === 'function') {
          audioPlayer.load();
        }
      } else {
        try {
          audioPlayer.currentTime = 0;
        } catch (_) {
          // noop
        }
      }
      applyAudioSettings();
      requestAudioPlayback();
      return;
    }

    if (fallbackAudioSrc) {
      applyAudioSettings();
      if (audioPlayer.paused) {
        requestAudioPlayback();
      }
      return;
    }

    audioPlayer.pause();
    audioPlayer.removeAttribute('src');
    activeAudioSrc = null;
    applyAudioSettings();
  };

  if (settingsToggle) {
    settingsToggle.addEventListener('click', (event) => {
      event.stopPropagation();
      if (settingsPanel) {
        settingsPanel.classList.toggle('is-open');
      }
    });
  }

  document.addEventListener('click', () => {
    if (settingsPanel) {
      settingsPanel.classList.remove('is-open');
    }
  });

  if (settingsPanel) {
    settingsPanel.addEventListener('click', (event) => event.stopPropagation());
  }

  if (overlayToggleButton) {
    overlayToggleButton.addEventListener('click', (event) => {
      event.stopPropagation();
      isOverlayVisible = !isOverlayVisible;
      applyOverlayVisibility();
    });
  }

  if (muteButton) {
    muteButton.addEventListener('click', () => {
      userMuted = !userMuted;
      applyAudioSettings();
    });
  }

  if (volumeSlider) {
    volumeSlider.addEventListener('input', (event) => {
      userVolume = Number(event.target.value);
      applyAudioSettings();
    });
  }

  const buildGraphLayout = () => {
    const columns = [];
    const positions = new Map();
    const depthByScene = new Map();
    const queue = [];
    const columnWidth = 160;
    const columnGap = 70;
    const rowGap = 120;
    const paddingX = 80;

    if (sceneMap.has(data.startSceneId)) {
      depthByScene.set(data.startSceneId, 0);
      queue.push(data.startSceneId);
    }

    while (queue.length) {
      const sceneId = queue.shift();
      const depth = depthByScene.get(sceneId) ?? 0;
      columns[depth] = columns[depth] || [];
      if (!columns[depth].includes(sceneId)) {
        columns[depth].push(sceneId);
      }
      const scene = sceneMap.get(sceneId);
      const sceneChoices = Array.isArray(scene && scene.choices) ? scene.choices : [];
      sceneChoices.forEach((choice) => {
        if (!choice.targetId || !sceneMap.has(choice.targetId)) return;
        if (!depthByScene.has(choice.targetId)) {
          depthByScene.set(choice.targetId, depth + 1);
          queue.push(choice.targetId);
        }
      });
    }

    sceneMap.forEach((_, sceneId) => {
      if (depthByScene.has(sceneId)) return;
      const depth = columns.length;
      columns[depth] = columns[depth] || [];
      columns[depth].push(sceneId);
      depthByScene.set(sceneId, depth);
    });

    let maxPerColumn = 1;
    columns.forEach((col = []) => {
      if (col.length > maxPerColumn) {
        maxPerColumn = col.length;
      }
    });
    const graphHeight = Math.max(480, maxPerColumn * rowGap + 160);
    const totalColumns = Math.max(columns.length, 1);
    const graphWidth = Math.max(
      paddingX * 2 + totalColumns * columnWidth + (totalColumns - 1) * columnGap,
      640
    );

    columns.forEach((col = [], depth) => {
      const columnHeight = (col.length - 1) * rowGap;
      const startY = (graphHeight - columnHeight) / 2;
      const x = paddingX + depth * (columnWidth + columnGap);
      col.forEach((sceneId, index) => {
        positions.set(sceneId, {
          x,
          y: Math.round(startY + index * rowGap),
        });
      });
    });

    const edges = [];
    sceneMap.forEach((scene) => {
      const sceneChoices = Array.isArray(scene && scene.choices) ? scene.choices : [];
      sceneChoices.forEach((choice) => {
        if (!choice.targetId || !sceneMap.has(choice.targetId)) return;
        edges.push({ from: scene.id, to: choice.targetId });
      });
    });

    return { columns, positions, edges, width: graphWidth, height: graphHeight };
  };

  const graphLayout = buildGraphLayout();

  const createSvgElement = (tag, attrs = {}) => {
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    Object.entries(attrs).forEach(([key, value]) => {
      if (value == null) return;
      el.setAttribute(key, value);
    });
    return el;
  };

  const renderStructureGraph = () => {
    if (!graphSvg || !graphLayout) return;
    graphSvg.innerHTML = '';
    graphSvg.setAttribute('viewBox', `0 0 ${graphLayout.width} ${graphLayout.height}`);

    const linesLayer = createSvgElement('g', { class: 'gal-graph-lines' });
    graphLayout.edges.forEach(({ from, to }) => {
      const start = graphLayout.positions.get(from);
      const end = graphLayout.positions.get(to);
      if (!start || !end) return;
      const line = createSvgElement('line', {
        x1: start.x,
        y1: start.y,
        x2: end.x,
        y2: end.y,
      });
      linesLayer.appendChild(line);
    });
    graphSvg.appendChild(linesLayer);

    const nodesLayer = createSvgElement('g', { class: 'gal-graph-nodes' });
    graphLayout.columns.forEach((column = []) => {
      column.forEach((sceneId) => {
        const position = graphLayout.positions.get(sceneId);
        if (!position) return;
        const classes = ['gal-graph-node'];
        if (unlockedScenes.has(sceneId)) classes.push('is-unlocked');
        if (currentSceneId === sceneId) classes.push('is-current');
        const group = createSvgElement('g', { class: classes.join(' ') });
        group.setAttribute('data-scene', sceneId);
        const circle = createSvgElement('circle', {
          cx: position.x,
          cy: position.y,
          r: 28,
        });
        group.appendChild(circle);
        if (unlockedScenes.has(sceneId)) {
          const labelScene = sceneMap.get(sceneId);
          const label = createSvgElement('text', {
            x: position.x,
            y: position.y + 46,
          });
          label.textContent = labelScene && labelScene.title ? labelScene.title : '';
          group.appendChild(label);
        }
        nodesLayer.appendChild(group);
      });
    });
    graphSvg.appendChild(nodesLayer);

    if (graphHint) {
      graphHint.textContent = unlockedScenes.size
        ? 'ç‚¹å‡»å·²è§£é”çš„èŠ‚ç‚¹å³å¯åˆ‡æ¢å‰§æƒ…'
        : 'æ¸¸ç©èŠ‚ç‚¹åå³å¯è§£é”ç»“æ„å›¾';
    }
  };

  const switchView = (nextView) => {
    const isScene = nextView === 'scene';
    const isGraph = nextView === 'graph';
    if (sceneView) {
      sceneView.classList.toggle('is-active', isScene);
      sceneView.setAttribute('aria-hidden', isScene ? 'false' : 'true');
    }
    if (graphView) {
      graphView.classList.toggle('is-active', isGraph);
      graphView.setAttribute('aria-hidden', isGraph ? 'false' : 'true');
    }
    if (viewToggleButton) {
      viewToggleButton.textContent = isScene ? 'å‰§æƒ…ç»“æ„å›¾' : 'èŠ‚ç‚¹å¹•';
      viewToggleButton.setAttribute('aria-pressed', isGraph ? 'true' : 'false');
    }
    viewState.current = nextView;
  };

  if (viewToggleButton) {
    viewToggleButton.addEventListener('click', (event) => {
      event.stopPropagation();
      switchView(viewState.current === 'scene' ? 'graph' : 'scene');
    });
  }

  if (graphSvg) {
    graphSvg.addEventListener('click', (event) => {
      const target = event.target;
      if (!target || typeof target.closest !== 'function') return;
      const node = target.closest('[data-scene]');
      if (!node) return;
      const sceneId = node.getAttribute('data-scene');
      if (!sceneId || !unlockedScenes.has(sceneId)) return;
      renderScene(sceneId);
      switchView('scene');
    });
  }

  const renderCharacters = (scene) => {
    if (!charactersLayer) return;
    charactersLayer.innerHTML = '';
    (scene.characters || []).forEach((character) => {
      if (!character.path) return;
      const el = document.createElement('div');
      el.className = 'gal-character';
      el.style.setProperty('--x', character.x ?? 50);
      el.style.setProperty('--y', character.y ?? 70);
      el.style.setProperty('--scale', character.scale ?? 1);
      el.innerHTML = `<img src="${character.path}" alt="${character.name || ''}" />`;
      charactersLayer.appendChild(el);
    });
  };

  const renderChoices = (scene) => {
    if (!choicesContainer) return;
    choicesContainer.innerHTML = '';
    if (!scene.choices || scene.choices.length === 0) {
      const button = document.createElement('button');
      button.textContent = 'ç»§ç»­';
      button.className = 'gal-choice';
      button.disabled = true;
      choicesContainer.appendChild(button);
      return;
    }
    scene.choices.forEach((choice) => {
      const button = document.createElement('button');
      button.textContent = choice.label || 'ç»§ç»­';
      button.className = 'gal-choice';
      const targetExists = choice.targetId && sceneMap.has(choice.targetId);
      button.disabled = !targetExists;
      button.addEventListener('click', () => {
        if (targetExists && choice.targetId) {
          renderScene(choice.targetId);
        }
      });
      choicesContainer.appendChild(button);
    });
  };

  const renderScene = (sceneId) => {
    const scene = sceneMap.get(sceneId);
    if (!scene) return;
    currentSceneId = sceneId;
    unlockedScenes.add(sceneId);

    if (stage) {
      stage.style.setProperty('--background-image', scene.background ? `url(${scene.background})` : 'none');
    }
    handleSceneAudio(scene);

    if (textTitle) {
      textTitle.textContent = scene.title;
    }
    if (textBody) {
      textBody.textContent = scene.text || 'ï¼ˆè¯¥åœºæ™¯æš‚æ— æ–‡æœ¬å†…å®¹ï¼‰';
    }

    renderCharacters(scene);
    renderChoices(scene);
    renderStructureGraph();
  };

  switchView('scene');
  renderScene(currentSceneId);
  applyOverlayVisibility();
})();
</script>
</body>
</html>